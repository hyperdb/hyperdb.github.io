---
import { getCollection } from "astro:content";
import type { PaginateFunction } from "astro";
import Layout from "@/layouts/Layout.astro";

export async function getStaticPaths({
    paginate,
}: {
    paginate: PaginateFunction;
}) {
    const posts = await getCollection("posts");

    // published のみをフィルタリングし、作成日時の降順でソート
    const publishedPosts = posts
        .filter((post) => post.data.status === "publish")
        .sort(
            (a, b) =>
                new Date(b.data.created_at).getTime() -
                new Date(a.data.created_at).getTime()
        );

    return paginate(publishedPosts, { pageSize: 5 });
}

const { page } = Astro.props;
---

<Layout>
    <div class="page-header">
        <h1>投稿一覧</h1>
        <p>全{page.total}件の投稿</p>
    </div>

    <ul class="post-list">
        {
            page.data.map((post) => (
                <li class="post-item">
                    <a href={`/posts/detail/${post.data.slug}`}>
                        <h2>{post.data.title}</h2>
                        <div class="post-meta">
                            <time
                                datetime={new Date(
                                    post.data.created_at
                                ).toISOString()}
                            >
                                {new Date(
                                    post.data.created_at
                                ).toLocaleDateString("ja-JP")}
                            </time>
                            {post.data.category && (
                                <span class="category">
                                    {post.data.category}
                                </span>
                            )}
                        </div>
                    </a>
                </li>
            ))
        }
    </ul>

    <nav class="pagination">
        {page.url.prev && <a href={page.url.prev}>← 前のページ</a>}
        <span class="page-info">
            ページ {page.currentPage} / {page.lastPage}
        </span>
        {page.url.next && <a href={page.url.next}>次のページ →</a>}
    </nav>

    <div class="post-footer">
        <a href="/">トップに戻る</a>
    </div>
</Layout>

<style lang="scss">
    .page-header p {
        font-size: 1rem;
        color: var(--theme-color5);
        margin-top: 0.5rem;
    }

    .post-meta {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 0.5rem;
    }

    .post-meta .category {
        background-color: var(--theme-color4);
        color: var(--color-text);
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    ul.post-list {
        li {
            list-style: none;
        }
    }
</style>
